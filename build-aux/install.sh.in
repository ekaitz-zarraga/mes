#! /bin/sh

# GNU Mes --- Maxwell Equations of Software
# Copyright Â© 2017,2018,2019 Jan (janneke) Nieuwenhuizen <janneke@gnu.org>
#
# This file is part of GNU Mes.
#
# GNU Mes is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or (at
# your option) any later version.
#
# GNU Mes is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with GNU Mes.  If not, see <http://www.gnu.org/licenses/>.

set -e

. ./config.status

mes_prefix=@prefix@/share/mes

# use bash or lose if pipes fail
if [ "$(basename $SHELL)" = bash ]; then
   set -o pipefail
fi

mkdir -p $DESTDIR@bindir@
if [ -f src/x86-mes-mes ]; then
    cp src/x86-mes-mes $DESTDIR@bindir@/mes
fi
cp scripts/mescc.scm $DESTDIR@bindir@/mescc.scm
cp scripts/mescc $DESTDIR@bindir@/mescc

sed \
    -e "s,^#! /bin/sh,#! @SHELL@," \
    scripts/diff.scm > $DESTDIR@bindir@/diff.scm
chmod +x $DESTDIR@bindir@/diff.scm

mkdir -p $DESTDIR@docdir@

if [ -n "@PERL@" ]\
       && [ -n "@GIT@" ]\
       && @PERL@ -v > /dev/null\
       && @GIT@ status > /dev/null; then
    @PERL@ ${srcdest}build-aux/gitlog-to-changelog --srcdir=. > ChangeLog
fi

cp\
    AUTHORS\
    BOOTSTRAP\
    COPYING\
    HACKING\
    INSTALL\
    NEWS\
    README\
    $DESTDIR@docdir@

if [ -f ChangeLog ]; then
    cp ChangeLog $DESTDIR@docdir@
else
    cp ChangeLog $DESTDIR@docdir@
fi

if [ -f ChangeLog ]; then
    cp ChangeLog @docdir@
else
    cp ChangeLog @docdir@
fi

mkdir -p $DESTDIR$mes_prefix
rm -f $(find lib -type f -a -executable)
rm -f $(find lib/tests -type f -a -name '*.1')
rm -f $(find lib/tests -type f -a -name '*.2')
rm -f $(find lib/tests -type f -a -name '*.o')
rm -f $(find lib/tests -type f -a -name '*.log')
rm -f $(find lib/tests -type f -a -name '*.x86-mes*')
rm -f $(find lib/tests -type f -a -name '*.x86_64-mes*')
rm -f $(find scaffold -type f -a -executable)
rm -f $(find scaffold -type f -a -name '*.1')
rm -f $(find scaffold -type f -a -name '*.2')
rm -f $(find scaffold -type f -a -name '*.o')
rm -f $(find scaffold -type f -a -name '*.S')
rm -f $(find scaffold -type f -a -name '*.log')
rm -f $(find scaffold -type f -a -name '*.x86-mes*')
rm -f $(find scaffold -type f -a -name '*.x86_64-mes*')
if [ -z "$srcdest" ]; then
    tar -cf- include lib | tar -xf- -C $DESTDIR$mes_prefix
    tar -cf- --exclude='*.go' module | tar -xf- -C $DESTDIR$mes_prefix
    tar -cf- scaffold | tar -xf- -C $DESTDIR$mes_prefix
else
    tar -cf- -C ${srcdest} include lib | tar -xf- -C $DESTDIR$mes_prefix
    tar -cf- -C lib | tar -xf- -C $DESTDIR$mes_prefix
    tar -cf- -C ${srcdest} module | tar -xf- -C $DESTDIR$mes_prefix
    tar -cf- -C ${srcdest} scaffold | tar -xf- -C $DESTDIR$mes_prefix
fi
tar -cf- -C ${srcdest}mes module | tar -xf- -C $DESTDIR$mes_prefix

if [ -f src/mes.x86-mes-S ]; then
    cp src/mes.x86-mes-S $DESTDIR$mes_prefix/lib/x86-mes/mes.S
fi
if [ -f src/mes.x86_64-mes-S ]; then
    cp src/mes.x86_64-mes-S $DESTDIR$mes_prefix/lib/x86_64-mes/mes.S
fi

mkdir -p ${DESTDIR}@guile_site_dir@
mkdir -p ${DESTDIR}@guile_site_ccache_dir@
tar -cf- -C ${srcdest}module --exclude='*.go' . | tar -xf- -C ${DESTDIR}@guile_site_dir@
tar -cf- -C module --exclude='*.scm' . | tar -xf- -C ${DESTDIR}@guile_site_ccache_dir@

if [ -f doc/mes.info ]; then
    mkdir -p ${DESTDIR}@infodir@
    tar -cf- doc/mes.info* doc/images | tar -xf- --strip-components=1 -C ${DESTDIR}@infodir@
    install-info --info-dir=${DESTDIR}@infodir@ doc/mes.info
fi

if [ -f doc/mes.1 ]; then
    mkdir -p ${DESTDIR}@mandir@/man1
    cp doc/mes.1 ${DESTDIR}@mandir@/man1/
fi

if [ -f doc/mescc.1 ]; then
    mkdir -p ${DESTDIR}@mandir@/man1
    cp doc/mescc.1 ${DESTDIR}@mandir@/man1/
fi
